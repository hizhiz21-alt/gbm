<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>グブ式会話ジェネレーター</title>

<style>
@font-face{
  font-family:"NewCinemaAStdD";
  src:url("./FOT-NewCinemaAStd-D.otf") format("opentype");
  font-display:swap;
}

html, body{
  height:100%;
  margin:0;
  background:#000;
  color:#fff;
  font-family:"NewCinemaAStdD", system-ui, -apple-system, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
  user-select:none;
  -webkit-tap-highlight-color:transparent;
}

#stage{
  position:fixed;
  inset:0;
  overflow:hidden;
  background:#000;
}

/* ===== scene ===== */
#scene{
  position:absolute;
  left:0;
  right:0;
  top:0;
  height:calc(100vh - var(--uiH, 0px));
  overflow:hidden;
}

.bg{
  position:absolute;
  inset:0;
  background-size:contain;
  background-position:bottom center;
  background-repeat:no-repeat;
  background-color:#000;
  transform:scale(1.05);
}

.chara{
  position:absolute;
  left:50%;
  bottom:0;
  transform:translateX(-50%);
  max-width:100%;
  max-height:100%;
  object-fit:contain;
  pointer-events:none;
}

/* ===== header ===== */
#header{
  position:absolute;
  left:0; right:0; top:0;
  z-index:5;
  pointer-events:none;
}
#header img{
  width:100%;
  display:block;
}

/* ===== UI ===== */
.ui{
  position:fixed;
  left:0; right:0; bottom:0;
  padding-bottom:env(safe-area-inset-bottom);
}
.ui-scale{
  position:relative;
  left:50%;
  transform:translateX(-50%) scale(var(--uiScale,1));
  transform-origin:bottom center;
  width:calc(var(--uiBaseW, 640) * 1px);
}
.window-img{
  display:block;
  width:100%;
}

/* text params */
:root{
  --nameLeft: 38px;
  --nameTop: -4px;
  --nameSize: 28px;
  --textLeft: 48px;
  --textRight: 54px;
  --textTop: 76px;
  --textSize: 26px;
  --textLine: 1.55;
  --textLetter: 0.02em;
  --hintRight: 28px;
  --hintBottom: 20px;
}

.name{
  position:absolute;
  left:var(--nameLeft);
  top:var(--nameTop);
  right:60px;
  font-size:var(--nameSize);
  color:rgba(255,255,255,.92);
  text-shadow:0 2px 6px rgba(0,0,0,.65);
  white-space:nowrap;
  overflow:hidden;
}

.text{
  position:absolute;
  left:var(--textLeft);
  right:var(--textRight);
  top:var(--textTop);
  font-size:var(--textSize);
  line-height:var(--textLine);
  letter-spacing:var(--textLetter);
  color:rgba(255,255,255,.90);
  text-shadow:0 2px 6px rgba(0,0,0,.68);
  white-space:pre-wrap;
  min-height:3.2em;
}

.hint{
  position:absolute;
  right:var(--hintRight);
  bottom:var(--hintBottom);
  display:none;
  animation:blink 1.2s infinite ease-in-out;
}
.hint img{
  width:80px;
}

@keyframes blink{
  0%,100%{opacity:.25}
  50%{opacity:1}
}

.tap{
  position:fixed;
  inset:0;
  z-index:20;
}

/* ===== editor ===== */
#editor{
  position:fixed;
  left:10px; right:10px; top:10px;
  z-index:30;
  background:rgba(0,0,0,.72);
  border-radius:12px;
  padding:10px;
}
.row{ display:flex; gap:8px; flex-wrap:wrap; }
.row > *{ flex:1 1 160px; }

label{ font-size:12px; }

input, textarea, button{
  width:100%;
  border-radius:10px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.08);
  color:#fff;
  padding:10px;
  font-size:14px;
}
textarea{ min-height:92px; resize:vertical; }

#miniBtn{
  position:fixed;
  right:10px; top:10px;
  z-index:25;
  width:44px; height:44px;
  border-radius:12px;
  display:none;
}
</style>
</head>

<body>
<div id="stage">
  <div id="scene">
    <div id="header"><img src="./header.png"></div>
    <div class="bg" id="bg"></div>
    <img class="chara" id="chara">
  </div>

  <div class="ui">
    <div class="ui-scale" id="uiScale">
      <img class="window-img" id="windowImg" src="./parts-sf4d7619aab.jpg">
      <div class="name" id="nameLayer"></div>
      <div class="text" id="textLayer"></div>
      <div class="hint" id="hint"><img src="./next.png"></div>
    </div>
  </div>

  <div class="tap" id="tap"></div>
</div>

<div id="editor">
  <div class="row">
    <div>
      <label>背景</label>
      <input type="file" id="bgFile">
    </div>
    <div>
      <label>立ち絵</label>
      <input type="file" id="charaFile">
    </div>
  </div>

  <label>キャラ名</label>
  <input type="text" id="nameInput" value="ジークフリート">

  <label>メッセージ（--- 区切り / [名前|画像]）</label>
  <textarea id="msgInput"></textarea>

  <button id="playBtn">再生</button>
</div>

<button id="miniBtn">✎</button>

<script>
const bg = document.getElementById("bg");
const chara = document.getElementById("chara");
const nameLayer = document.getElementById("nameLayer");
const textLayer = document.getElementById("textLayer");
const hint = document.getElementById("hint");
const tap = document.getElementById("tap");
const editor = document.getElementById("editor");
const miniBtn = document.getElementById("miniBtn");

let lines=[], idx=0, timer=null, full="", cursor=0, typing=false;
let baseName="", baseCharaSrc="";

function parse(raw){
  return raw.split(/\n---\n/).map(s=>s.trim()).filter(Boolean);
}

function parseLine(line){
  const m = line.match(/^\[(.+?)\|(.+?)\]\s*(.*)$/);
  if(m){
    return { name:m[1], img:m[2], text:m[3] };
  }
  return { name:baseName, img:baseCharaSrc, text:line };
}

function showLine(i){
  if(timer) clearInterval(timer);
  idx=i;
  const d=parseLine(lines[idx]);
  nameLayer.textContent=d.name;
  if(d.img){
    chara.src="./chara/"+d.img;
    chara.style.display="block";
  }
  full=d.text;
  cursor=0;
  textLayer.textContent="";
  typing=true;
  hint.style.display="none";
  timer=setInterval(()=>{
    cursor++;
    textLayer.textContent=full.slice(0,cursor);
    if(cursor>=full.length){
      clearInterval(timer);
      typing=false;
      hint.style.display="block";
    }
  },30);
}

function next(){
  if(typing){
    textLayer.textContent=full;
    typing=false;
    hint.style.display="block";
    return;
  }
  idx=(idx+1)%lines.length;
  showLine(idx);
}

document.getElementById("playBtn").onclick=()=>{
  baseName=document.getElementById("nameInput").value.trim();
  lines=parse(document.getElementById("msgInput").value);
  editor.style.display="none";
  miniBtn.style.display="block";
  showLine(0);
};

tap.onclick=next;
miniBtn.onclick=()=>{
  editor.style.display="block";
  miniBtn.style.display="none";
  hint.style.display="none";
};
</script>
</body>
</html>
